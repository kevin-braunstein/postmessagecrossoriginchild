<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Child iFrame</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #e3f2fd; border-left: 5px solid #2196F3; }
        h3 { margin-top: 0; color: #0d47a1; }
        .step-box { background: #fff; padding: 10px; margin-bottom: 10px; border: 1px solid #bbdefb; }
        button { cursor: pointer; padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 3px; margin-right: 5px; }
        button:hover { background: #1976D2; }
        .code-output { background: #333; color: #fff; padding: 8px; font-family: monospace; font-size: 12px; margin-top: 5px; min-height: 20px; white-space: pre-wrap; }
        .highlight { color: #ffff00; font-weight: bold; }
        .success { color: #69f0ae; font-weight: bold; }
    </style>
</head>
<body>

    <h3>Child iFrame (Different Origin)</h3>

    <div class="step-box">
        <strong>Steps 3-5 (Previous)</strong>
        <p>Use these to setup the environment if needed.</p>
        <button onclick="inspectParent()">Step 3: Inspect</button>
        <button onclick="sendMessage('Test')">Step 4: Send</button>
        <button onclick="attemptProxyAttack()">Step 5: Proxy Parent</button>
    </div>

    <div class="step-box" style="border-color: #5cb85c; border-width: 2px;">
        <strong>Step 6: Capture Source</strong>
        <p>Wait for Parent Step 3 ("Hello Child").</p>
        <div id="sourceStatus" style="color: #666; font-style: italic; margin-bottom:5px;">Waiting for message...</div>
        <div id="analysisOutput" class="code-output">Analysis Log...</div>
    </div>

    <div class="step-box" style="border-color: #d32f2f; border-width: 2px;">
        <strong>Step 7: Proxy Attack on Event.Source</strong>
        <p>Wrap the captured <code>event.source</code> in a Proxy and overwrite the property on the event object.</p>
        
        <button onclick="proxySourceAttack()">Inject Proxy on Source</button>
        <button onclick="testPoisonedSource()">Test (Send Message)</button>
        
        <div id="sourceAttackLog" class="code-output">Ready to attack...</div>
    </div>

    <script>
        let lastEvent = null; // Store the whole event object
        
        function log(id, msg) {
            document.getElementById(id).innerHTML += msg + "\n";
        }

        // --- PREVIOUS HELPERS (Condensed) ---
        function inspectParent() { 
            try { log('analysisOutput', "Sig: " + window.parent.postMessage.toString()); } catch(e) { log('analysisOutput', e.message); }
        }
        function sendMessage(msg) { window.parent.postMessage(msg, "*"); }
        function attemptProxyAttack() {
            try {
                const proxy = new Proxy(window.parent, {
                    get: (t, p, r) => (p === "postMessage") ? (msg) => log('proxyOutput', `TRAP: ${msg}`) : Reflect.get(t, p, r)
                });
                window.__defineGetter__("parent", () => proxy);
                log('proxyOutput', "Parent Shadowed.");
            } catch(e) { log('proxyOutput', "Fail: " + e.message); }
        }

        // --- STEP 6 LOGIC ---
        window.addEventListener("message", (event) => {
            document.getElementById('sourceStatus').innerHTML = "<b>Message Received!</b> Event captured.";
            document.getElementById('sourceStatus').style.color = "#000";
            
            // Capture the whole event object to modify it later
            lastEvent = event; 
            log('analysisOutput', `[RX] Captured event from: ${event.origin}`);
        });

        // --- STEP 7: PROXY ATTACK ON SOURCE ---
        function proxySourceAttack() {
            const out = document.getElementById('sourceAttackLog');
            out.innerText = "Initializing Proxy Attack on event.source...\n";

            if (!lastEvent) {
                out.innerText += "Error: No event captured. Run Parent Step 3 first.";
                return;
            }

            try {
                // 1. Keep reference to real source
                const realSource = lastEvent.source;

                // 2. Create the Trap
                const handler = {
                    get: function(target, prop, receiver) {
                        if (prop === "postMessage") {
                            return function(msg) {
                                out.innerHTML += `<span class='success'>[INTERCEPTED]</span> Proxy on event.source caught: "${msg}"\n`;
                                // Optionally forward it if we wanted to be sneaky:
                                // target.postMessage(msg, "*"); 
                            };
                        }
                        return Reflect.get(target, prop, receiver);
                    }
                };

                // 3. Create Proxy
                const sourceProxy = new Proxy(realSource, handler);

                // 4. Overwrite the 'source' property on the EVENT OBJECT
                // We cannot change the WindowProxy, but we CAN change the event object property
                Object.defineProperty(lastEvent, 'source', {
                    get: function() {
                        return sourceProxy;
                    },
                    configurable: true
                });

                out.innerHTML += "Proxy injected into lastEvent.source.\n";
                out.innerHTML += "Variable 'lastEvent.source' is now POISONED.\n";

            } catch (e) {
                out.innerHTML += `[FAILED]: ${e.message}\n`;
            }
        }

        function testPoisonedSource() {
            const out = document.getElementById('sourceAttackLog');
            if (!lastEvent) return;

            out.innerHTML += "Calling lastEvent.source.postMessage()...\n";
            
            // This call should hit our Proxy Trap, NOT the browser native sender
            lastEvent.source.postMessage("This should be intercepted", "*");
        }

    </script>
</body>
</html>
