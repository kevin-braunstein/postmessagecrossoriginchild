<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Child iFrame</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #e3f2fd; border-left: 5px solid #2196F3; }
        h3 { margin-top: 0; color: #0d47a1; }
        .step-box { background: #fff; padding: 10px; margin-bottom: 10px; border: 1px solid #bbdefb; }
        button { cursor: pointer; padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 3px; margin-right: 5px; }
        button:hover { background: #1976D2; }
        .code-output { background: #333; color: #fff; padding: 8px; font-family: monospace; font-size: 12px; margin-top: 5px; min-height: 20px; white-space: pre-wrap; }
        .highlight { color: #ffff00; font-weight: bold; }
        .success { color: #69f0ae; font-weight: bold; }
        .critical { color: #ff5252; font-weight: bold; }
    </style>
</head>
<body>

    <h3>Child iFrame (Different Origin)</h3>

    <div class="step-box">
        <strong>Setup / Debug</strong>
        <button onclick="inspectParent()">Inspect Sig</button>
        <button onclick="location.reload()">Reset Frame</button>
    </div>

    <div class="step-box" style="border-color: #5cb85c; border-width: 2px;">
        <strong>Step 6: Monitor Incoming</strong>
        <p>Wait for Parent Step 3 ("Hello Child").</p>
        <div id="sourceStatus" style="color: #666; font-style: italic; margin-bottom:5px;">Waiting...</div>
        <div id="analysisOutput" class="code-output">Log...</div>
    </div>

    <div class="step-box" style="border-color: #d32f2f; border-width: 2px;">
        <strong>Step 8: Global Prototype Attack</strong>
        <p>Override <code>MessageEvent.prototype.source</code> to automatically proxy ALL future messages.</p>
        
        <button onclick="applyGlobalHack()">1. Apply Global Hack</button>
        <button onclick="testLastCaptured()">2. Test Last Captured Source</button>
        
        <div id="globalLog" class="code-output">Ready...</div>
    </div>

    <script>
        let lastCapturedEvent = null;

        function log(id, msg) {
            document.getElementById(id).innerHTML += msg + "\n";
        }
        function inspectParent() { try { log('analysisOutput', window.parent.postMessage.toString()); } catch(e) {} }

        // --- STEP 6: CAPTURE EVENTS ---
        window.addEventListener("message", (event) => {
            document.getElementById('sourceStatus').innerHTML = "<b>Message Received!</b>";
            lastCapturedEvent = event;
            log('analysisOutput', `[RX] New message received from: ${event.origin}`);
            
            // Auto-check if it was poisoned
            try {
                // If our hack is working, accessing event.source.postMessage should trigger our trap
                // We use toString() or just check if it behaves weirdly.
                // But mostly we wait for the user to click "Test" to verify interception.
            } catch(e) {}
        });

        // --- STEP 8: GLOBAL PROTOTYPE ATTACK ---
        function applyGlobalHack() {
            const out = document.getElementById('globalLog');
            out.innerText = "Applying Prototype Override...\n";

            try {
                // 1. Get the original native getter
                // We need this so we can still get the REAL source internally
                const originalDescriptor = Object.getOwnPropertyDescriptor(MessageEvent.prototype, 'source');
                const originalGetter = originalDescriptor.get;

                if (!originalGetter) {
                    throw new Error("Could not find native getter for 'source'.");
                }

                // 2. Define the PROXY HANDLER (The Trap)
                const handler = {
                    get: function(target, prop, receiver) {
                        if (prop === "postMessage") {
                            return function(msg) {
                                out.innerHTML += `<span class='success'>[GLOBAL TRAP]</span> Intercepted: "${msg}"\n`;
                            };
                        }
                        return Reflect.get(target, prop, receiver);
                    }
                };

                // 3. Overwrite the Prototype Property
                Object.defineProperty(MessageEvent.prototype, 'source', {
                    get: function() {
                        // A. Call the original getter to get the real WindowProxy
                        const realSource = originalGetter.call(this);
                        
                        if (!realSource) return null;

                        // B. Wrap it in our Proxy
                        return new Proxy(realSource, handler);
                    },
                    configurable: true // Usually true for WebIDL
                });

                out.innerHTML += "<span class='critical'>[SUCCESS]</span> MessageEvent.prototype.source is now compromised.\n";
                out.innerHTML += "Any message received from now on (or existing events read again) will yield a poisoned source.\n";

            } catch (e) {
                out.innerHTML += `[FAILED]: ${e.message}\n`;
            }
        }

        function testLastCaptured() {
            const out = document.getElementById('globalLog');
            if (!lastCapturedEvent) {
                out.innerHTML += "No event captured yet. Ask Parent to send a message.\n";
                return;
            }

            out.innerHTML += "Reading lastCapturedEvent.source.postMessage('Hack')...\n";
            // If the global hack worked, this property access now runs our new Getter -> returns Proxy -> runs Trap.
            lastCapturedEvent.source.postMessage("Global Hack Test", "*");
        }

    </script>
</body>
</html>
