<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Frame</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #e0f7fa; }
        .log-box { background: white; border: 1px solid #00acc1; padding: 10px; height: 200px; overflow-y: scroll; margin-top: 10px; font-family: monospace; }
        button { padding: 10px 20px; cursor: pointer; background: #00acc1; color: white; border: none; border-radius: 4px; font-size: 16px; margin: 5px 0; }
        button:hover { background: #00838f; }
    </style>
</head>
<body>
    <h1>Child Frame</h1>
    <p>This frame is inside the parent.</p>
    
    <button onclick="sendNormalMessage()">1. Send Normal Message</button>
    <button onclick="interceptPostMessage()">2. Intercept (Override) postMessage</button>
    <button onclick="sendNormalMessage()">3. Send Message (After Override)</button>

    <h3>Internal Log (Outgoing Data):</h3>
    <div id="childLogger" class="log-box"></div>

    <script>
        const logger = document.getElementById('childLogger');

        function log(msg, color = 'black') {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            div.style.color = color;
            logger.appendChild(div);
            logger.scrollTop = logger.scrollHeight;
        }

        // 1. Function to send a message normally
        function sendNormalMessage() {
            const payload = { text: "Hello from Child", timestamp: Date.now() };
            
            // This attempts to send data to the parent
            try {
                window.parent.postMessage(payload, "https://kevinbraunstein.github.io");
                log(`Sent payload: ${JSON.stringify(payload)}`);
            } catch (e) {
                log(`Error sending: ${e.message}`, 'red');
            }
        }

        // 2. The Interception Logic
        function interceptPostMessage() {
            log("--- INITIATING INTERCEPT ---", 'blue');

            // A. Save the original native function
            const originalPostMessage = window.parent.postMessage;

            // B. Overwrite the function on the window.parent object
            // Note: We are overwriting the reference we have to the parent's postMessage
            window.parent.postMessage = function(message, targetOrigin, transfer) {
                
                // C. Log the interception details
                log(`[INTERCEPTED] Data: ${JSON.stringify(message)} | Target: ${targetOrigin}`, 'green');

                // D. Call the original function so the app doesn't break
                // We use .call() to ensure 'this' context is correct, though usually fine here.
                return originalPostMessage.call(window.parent, message, targetOrigin, transfer);
            };

            log("--- OVERRIDE COMPLETE ---", 'blue');
        }
    </script>
</body>
</html>
