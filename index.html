<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Child iFrame</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 15px; background: #e3f2fd; border-left: 5px solid #2196F3; }
        h3 { margin-top: 0; color: #0d47a1; }
        
        .step-box { background: #fff; padding: 10px; margin-bottom: 10px; border: 1px solid #bbdefb; }
        
        button { cursor: pointer; padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 3px; }
        button:hover { background: #1976D2; }
        
        .code-output { background: #333; color: #fff; padding: 8px; font-family: monospace; font-size: 12px; margin-top: 5px; min-height: 20px; white-space: pre-wrap; }
        .highlight { color: #ffff00; font-weight: bold; }
        .fail { color: #ff5252; font-weight: bold; }
    </style>
</head>
<body>

    <h3>Child iFrame (Different Origin)</h3>

    <div class="step-box">
        <strong>Step 3: Inspect Parent Signature</strong>
        <p>Look at <code>parent.postMessage</code> from this origin.</p>
        <button onclick="inspectParent()">Inspect Signature</button>
        <div id="inspectOutput" class="code-output">Ready to inspect...</div>
    </div>

    <div class="step-box">
        <strong>Step 4: Standard Send</strong>
        <p>Attempt to send a message normally.</p>
        <button onclick="sendMessage('Standard Hello')">Send Message</button>
        <div id="sendOutput" class="code-output">Ready to send...</div>
    </div>

    <div class="step-box" style="border-color: #f0ad4e;">
        <strong>Step 5: Proxy Attack</strong>
        <p>Attempt to redefine <code>window.parent</code> using a Proxy to intercept calls.</p>
        <button onclick="attemptProxyAttack()">Inject Proxy & Send</button>
        <div id="proxyOutput" class="code-output">Ready to attack...</div>
    </div>

    <script>
        function log(id, msg) {
            document.getElementById(id).innerHTML += msg + "\n";
        }

        // --- STEP 3 LOGIC ---
        function inspectParent() {
            const out = document.getElementById('inspectOutput');
            out.innerText = "";
            try {
                const signature = window.parent.postMessage.toString();
                log('inspectOutput', `Signature: ${signature}`);
                
                if (signature.includes("native code")) {
                    log('inspectOutput', "[ANALYSIS]: We see Native Code. Parent's override is hidden.");
                } else {
                    log('inspectOutput', "[ANALYSIS]: We see custom JavaScript.");
                }
            } catch(e) {
                log('inspectOutput', "Error inspecting: " + e.message);
            }
        }

        // --- STEP 4 LOGIC ---
        function sendMessage(msg) {
            const out = document.getElementById('sendOutput');
            out.innerText = "Sending: " + msg;
            window.parent.postMessage(msg, "*");
            out.innerText += "\nMessage sent. Check Parent Log.";
        }

        // --- STEP 5: THE PROXY ATTACK ---
        function attemptProxyAttack() {
            const out = document.getElementById('proxyOutput');
            out.innerText = "Initializing Proxy Attack...\n";

            try {
                // 1. Create the Handler
                const handler = {
                    get: function(target, prop, receiver) {
                        // Intercept postMessage
                        if (prop === "postMessage") {
                            return function(msg) {
                                log('proxyOutput', `>> PROXY TRAP: Dropped message "${msg}"`);
                            };
                        }
                        // Pass everything else through to the real parent
                        return Reflect.get(target, prop, receiver);
                    }
                };

                // 2. Create the Proxy wrapping the real parent
                // Note: We wrap window.parent, not Window constructor, to target the instance
                const proxy = new Proxy(window.parent, handler);

                // 3. Attempt to override window.parent
                // This is the critical security check
                window.__defineGetter__("parent", function() {
                    return proxy;
                });

                log('proxyOutput', "Proxy attached to window.parent.");
                
                // 4. Try to send through the 'hacked' parent
                log('proxyOutput', "Attempting to send 'Proxy Message'...");
                window.parent.postMessage("Proxy Message", "*");

            } catch (e) {
                out.innerHTML += `<span class='fail'>[ATTACK FAILED]: ${e.message}</span>\n`;
                out.innerHTML += "Analysis: window.parent is non-configurable. The browser prevented the override.";
                
                // Fallback check - did the message go through anyway?
                out.innerHTML += "\n(Check Parent Log - if message appeared, the browser ignored our Proxy)";
                // Try sending anyway to prove the real parent is still there
                window.parent.postMessage("Proxy Failed - Real Message Sent", "*");
            }
        }
    </script>
</body>
</html>
